var CiiMSComments={storage:null,getStoredInfoBy:function(e){return null==CiiMSComments.storage&&(CiiMSComments.storage=jQuery.parseJSON(localStorage.getItem("ciims"))),CiiMSComments.storage[e]},load:function(e){void 0==e&&(e=$(".comment-count").attr("data-attr-id"));var t=$("#endpoint").attr("data-attr-endpoint")+"/";$("#ciims_comments").html("<div class='comment_loader'></div><div class='comment_messages'><div class='clearfix'></div></div><h3>Comments</h3><div class='new_comment'></div><div class='comments_container' style='display:none'></div>");var n=CiiMSComments.getStoredInfoBy("isAuthenticated");if(1==n){var r='<div class="comment template_container"><div class="pull-left comment_person"></div><div class="pull-left comment_body"><div class="comment_body_inner"></div></div><div class="clearfix"></div></div>';$(".new_comment").append(r);var i=$(".template_container").clone();$(".template_container").remove();var o=$("<img>").attr({src:"http://www.gravatar.com/avatar/"+md5(CiiMSComments.getStoredInfoBy("email"))+"?s=30"});$(i).find(".comment_person").append($(o));var s=$("<form>").addClass("pure-form"),a=$("<input>").attr("type","text").addClass("comment_box pure-u-1").attr("placeholder","Add a Comment...").attr("name","comment_box");$(s).append($(a)),$(i).find(".comment_body_inner").append($(s)),$(".new_comment").html($(i)),CiiMSComments.behaviors.bind()}else{var u=$("<a>").attr("href",t+"login?next="+window.location.href.replace(t,"")).addClass("alert alert-info").html("You must be logged in to post new comments");$("#ciims_comments").find(".comment_messages").show().prepend($(u))}$.ajax({url:t+"api/comment/comments/id/"+e,type:"get",headers:{"X-Auth-Email":CiiMSComments.getStoredInfoBy("email"),"X-Auth-Token":CiiMSComments.getStoredInfoBy("token")},dataType:"json",success:function(e){var t='<div class="comment template"><div class="pull-left comment_person"></div><div class="pull-left comment_body"><div class="comment_body_byline"></div><div class="comment_body_inner"></div></div><div class="clearfix"></div></div>';$(".comments_container").append(t),$.each(e.response,function(){CiiMSComments.behaviors.showComment(this)}),CiiMSComments.behaviors.bindMod(),$(".timeago").timeago(),$(".comments_container").show(),$(".comment_loader").fadeOut()}})},commentCount:function(){var e=$("#endpoint").attr("data-attr-endpoint")+"/",t=[];$(".comment-count").each(function(){var n=$(this).attr("data-attr-id");t.push(n),$(this).hasClass("registered")||$(this).addClass("registered").append('<a href="'+e+$(this).attr("data-attr-slug")+'#comment" data-ciimscomments-identifier="'+n+'">0</a>')}),CiiMSComments.more(),0!=t.length&&$.post(e+"/api/comment/count",{ids:t},function(e){$.each(e.response,function(e,t){$("[data-ciimscomments-identifier="+e+"]").text(t)})})},more:function(e){$("a#more").click(function(){setTimeout(function(){CiiMSComments.commentCount()},500)}),1==e&&setTimeout(function(){CiiMSComments.commentCount()},500)},behaviors:{showComment:function(e,t){void 0==t&&(t=!1);var n=CiiMSComments.getStoredInfoBy("role"),r=CiiMSComments.getStoredInfoBy("isAuthenticated"),i=$(".comment.template").clone(),o=$("<img>").attr({src:"http://www.gravatar.com/avatar/"+md5(e.user.email)+"?s=30"});$(i).removeClass("template").find(".comment_person").append($(o));var s=$("<span class='author'><a href='"+endpoint+"/profile/"+e.user_id+"'>"+e.user.displayName+"</a></span>"),a=new Date(1e3*e.created),u=a.format("c"),l=$("<span class='timeago' title='"+u+"'>"+u+"</span>"),c=$("<div>").addClass("mod_container pull-right"),f=$("<a>").addClass("flag_comment fa fa-flag").attr("href","#").attr("data-attr-id",e.id),p=$("<a>").addClass("delete_comment fa fa-times").attr("href","#").attr("data-attr-id",e.id);if(7==n||9==n){if(1==e.banned_comment){var d=$("<span>").addClass("orange").text("shadowbanned");$(c).append($(d)).append(" &#183; ")}$(c).append($(f)).append(" &#183; ").append($(p))}else"true"==r?$(c).append($(f)):$(c);$(i).find(".comment_body_byline").append($(s)).append(" &#183; ").append($(l)).append($(c)),$(i).find(".comment_body_inner").html(marked(e.comment)),t?$(".comments_container").prepend(i):$(".comments_container").append(i)},bindMod:function(){$(".flag_comment").click(function(e){e.preventDefault();var t=$(this).attr("data-attr-id"),n=$(this);return $.ajax({url:$("#endpoint").attr("data-attr-endpoint")+"/api/comment/flag/id/"+t,type:"post",headers:{"X-Auth-Email":CiiMSComments.getStoredInfoBy("email"),"X-Auth-Token":CiiMSComments.getStoredInfoBy("token")},dataType:"json",beforeSend:function(){$(n).addClass("orange")},error:function(){setTimeout(function(){$(n).removeClass("orange")},1e3)}}),!1}),$(".delete_comment").click(function(e){e.preventDefault();var t=$(this).attr("data-attr-id"),n=$(this);return $.ajax({url:$("#endpoint").attr("data-attr-endpoint")+"/api/comment/index/id/"+t,type:"delete",headers:{"X-Auth-Email":CiiMSComments.getStoredInfoBy("email"),"X-Auth-Token":CiiMSComments.getStoredInfoBy("token")},dataType:"json",beforeSend:function(){$(n).addClass("orange")},error:function(){setTimeout(function(){$(n).removeClass("orange")},1e3)},success:function(){$(n).parent().parent().parent().parent().fadeOut().remove()}}),!1})},bind:function(){$(".comment_box").focus(function(){var e=$("<textarea>").attr("type","text").addClass("comment_box pure-u-1 pure-focus").attr("placeholder","Add a Comment...").attr("name","comment_box");$(this).replaceWith($(e)),$(".comment_box").focus();var t=$("<input>").attr("type","submit").attr("id","comment_submit_button").addClass("pure-button pull-right pure-button-primary comment_button"),n=$("<a>").attr("href","#").addClass("pure-button pull-right cancel_button").text("Cancel");$(".comment_box").after($(n)).after($(t)),$("a.cancel_button").click(function(){var e=$("<input>").attr("type","text").addClass("comment_box pure-u-1 pure-focus").attr("placeholder","Add a Comment...").attr("name","comment_box");$(".comment_box").replaceWith($(e)),$(".new_comment").find("input#comment_submit_button").remove(),$(".new_comment").find("a").remove(),$(".comment_box").removeClass("pure-focus"),CiiMSComments.behaviors.bind()}),$("#comment_submit_button").click(function(e){e.preventDefault();var t=$(".comment_box").val();return""==t?($(".comment_box").addClass("error"),setTimeout(function(){$(".comment_box").removeClass("error")},2e3),!1):($.ajax({url:$("#endpoint").attr("data-attr-endpoint")+"/api/comment",type:"post",data:{comment:t,content_id:$(".comment-count").attr("data-attr-id")},headers:{"X-Auth-Email":CiiMSComments.getStoredInfoBy("email"),"X-Auth-Token":CiiMSComments.getStoredInfoBy("token")},dataType:"json",beforeSend:function(){$("input#comment_submit_button").attr("disabled","disabled")},error:function(){$("input#comment_submit_button").removeAttr("disabled"),$(".comment_box").addClass("error"),setTimeout(function(){$(".comment_box").removeClass("error")},2e3)},success:function(e){CiiMSComments.behaviors.showComment(e.response,!0),CiiMSComments.behaviors.bindMod(),$(".timeago").timeago(),$("a.cancel_button").click()}}),!1)})})}}},Comments={load:function(e){Disqus.load(e)},reload:function(e){CiiMSComments.load(e)},more:function(){CiiMSComments.more(!0)}};